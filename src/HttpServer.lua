---
--- @module HttpServer
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by benjamin.
--- DateTime: 1/04/22 11:28
---

local httpServerM = require "http.server"
local headersM = require 'http.headers'
local Status = require 'Status'
local Request = require 'Request'
local TableUtils = require 'utils.Table'


---@field public server http.server
---@field public route RouteRepository
---@field public timeout number @default 10
local self = {
    server = nil, -- Server
    routeRepository = require "RouteRepository", -- Route
    timeout = 10, -- Client timeout in seconds
}

-- Creating the http(s) server
-- @param string host Host of server (default: 0.0.0.0)
-- @param port Port of server (default: 0)
self.init = function(host, port)
    host = host or "0.0.0.0"
    port = port or 0

    self.server = httpServerM.listen{
        host = host,
        port = port,
        onstream = self.onRequest,
        version = 1.1,
    }

    -- self.server.settimeout(self.timeout)
    print(("Create HttpServer on port %d"):format(port))
end

---Listening for http requests
self.listen = function()
    self.server:listen()
    self.server:loop()
end

-- Used to stop server
self.stop = function()
    print("HttpServer stop")
    self.server:close()
end


self.onRequest = function(sv, stream)
    local request = TableUtils.readOnly(Request.new(stream)) -- Create a read only request
    local path = request.path -- Get path

    local found, response = self.routeRepository.tryRoute(path, request) -- Try to find a route
    if not found then
        request.setResponseHeaders({
            [':status'] = Status.NOT_FOUND
        })
    else
        if response ~= nil and response.execute ~= nil then
            response.execute(request) -- Execute the response builder
        end
    end

    request.flush() -- Flush the response
end


---Adding route to http server request dispatcher
---@param path string Route path
---@param methods string|table Route method(s)
---@param handler function handler called when request
self.route = function(path, methods, handler)
    self.routeRepository.add(path, methods, handler)
end


return {
    init = self.init,
    listen = self.listen,
    stop = self.stop,
    route = self.route
}
